---
title: "brt"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = F}
library(here)
library(tidyverse)
library(magrittr)

source(here("elith_tutorial", "brt.functions.R"))

set.seed(8878896)
```

```{r}
gmpd_ecoreg_psr <- readRDS(here("data", "processed_data", "gmpd_ecoreg_psr.rds"))

worldclim_mean <- readRDS(here("data", "processed_data", "worldclim_mean.rds"))

prop_max_rich <- readRDS(here("data", "processed_data", "ratios", "prop_max_rich_ecoreg.rds"))

gmpd_ecoreg_effort <- readRDS(here("data", "processed_data", "gmpd_ecoreg_effort.rds"))
```

```{r}
gmpd_ecoreg_effort %<>% rename(effort=n,
                               ecoreg=ECO_CODE)
```

```{r}
gmpd_ecoreg_psr %<>% left_join(., gmpd_ecoreg_effort)
gmpd_ecoreg_psr %<>% left_join(., worldclim_mean, by="ecoreg")

gmpd_ecoreg_psr %<>% dplyr::select(-c(na))


```

```{r}
brt <- gbm.step(data = as.data.frame(gmpd_ecoreg_psr), 
                gbm.x = 3:ncol(gmpd_ecoreg_psr), 
                gbm.y = 1, 
                family = "poisson", 
                tree.complexity = 5, 
                learning.rate = 0.004, 
                bag.fraction = 0.5)
```

```{r}
summary(brt)
```

```{r}
gbm.plot(brt, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T)
```






```{r}
prop_max_rich %<>% left_join(., gmpd_ecoreg_effort)
prop_max_rich %<>% left_join(., worldclim_mean)

prop_max_rich %<>% filter(!is.na(effort) & ratio<=1) %>% dplyr::select(-c(na, para.x, para.y))


```

```{r, eval=F}
brt_ratio <- gbm.step(as.data.frame(prop_max_rich), 
              gbm.x = c(2,4:ncol(gmpd_ecoreg_psr)), 
              gbm.y = 3, 
              family = "", 
              tree.complexity = 5, 
              learning.rate = 0.004, 
              bag.fraction = 0.5)
```

#try another way

Is the parasite present in an ecoreg?
 - worldclim variables
 - parasite classifications
 - number of viable hosts in that ecoreg
 
 - each row is one parasite in on ecoregion and whether or not they are present

host_para_mat is all of the host-parasite associations from gmpd
ecoreg_host_mat is all of the host presences in ecoregions

ecoreg_para_mat is every parasite's actual ecoregion presence as estimated by host_para_mat and ecoreg_host_mat
null_para_df is every parasite's possible presence in an ecoregion due to host presence

```{r}
host_para_mat <- readRDS(here("data", "processed_data", "para_mat.rds"))
ecoreg_host_mat <- readRDS(here("data", "processed_data", "ecoreg_mat.rds"))
ecoreg_para_mat <- readRDS(here("data", "processed_data", "ecoreg_para_mat.rds"))
null_para_df <- readRDS(here("data", "processed_data", "null_para_df.rds"))
```

```{r}
ecoreg_names <- colnames(ecoreg_para_mat[2:ncol(ecoreg_para_mat)])
ecoreg_para_long <- ecoreg_para_mat %>% 
  pivot_longer(cols = all_of(ecoreg_names)) %>%
  filter(value==1) %>%
  rename(pres = value,
         para = ParasiteCorrectedName)
```

ecoreg_para_long is every ecoregion where the parasite is actually present

```{r}
pres_abs_df <- null_para_df %>% 
  left_join(., ecoreg_para_long, by = c("para", "name")) %>%
  mutate(pres = replace_na(pres, 0))

hosts_available <- pres_abs_df %>% 
  dplyr::select(sci_name, para, name) %>% 
  group_by(para, name) %>% 
  summarize(avail_hosts = n())

pres_abs_df %<>% dplyr::select(para, name, pres) %>% distinct()

pres_abs_df %<>% left_join(., hosts_available)
```

```{r}
pres_abs_df %<>% rename(ecoreg = name)
pres_abs_df %<>% left_join(., worldclim_mean, by="ecoreg")
pres_abs_df %<>% left_join(., gmpd_ecoreg_effort, by="ecoreg")
```

```{r}
pres_abs_df %<>% drop_na() %>% dplyr::select(-c(na))
```

```{r}
train <- sample(1:nrow(pres_abs_df), nrow(pres_abs_df) * 0.8)
test <- pres_abs_df %>% mutate(row_num = rownames(.)) %>% filter(!row_num %in% train) %>% dplyr::select(row_num)
test <- as.integer(test$row_num)

pres_abs_df_train <- pres_abs_df[train, ]
pres_abs_df_test <- pres_abs_df[test, ]
```


```{r, eval=F}
brt1 <- gbm.step(as.data.frame(pres_abs_df), 
              gbm.x = c(4:ncol(pres_abs_df)), 
              gbm.y = 3, 
              family = "bernoulli", 
              tree.complexity = 4, 
              learning.rate = 0.01, 
              bag.fraction = 0.5)

brt2 <- gbm.step(as.data.frame(pres_abs_df), 
              gbm.x = c(5:(ncol(pres_abs_df)-1)), 
              gbm.y = 3, 
              family = "bernoulli", 
              tree.complexity = 4, 
              learning.rate = 0.01, 
              bag.fraction = 0.5)

brt3 <- gbm.step(as.data.frame(pres_abs_df_train), 
              gbm.x = c(4:ncol(pres_abs_df_train)), 
              gbm.y = 3, 
              family = "bernoulli", 
              tree.complexity = 4, 
              learning.rate = 0.01, 
              bag.fraction = 0.5)
```

```{r, eval=F}
summary(brt1)
summary(brt2)
summary(brt3)

saveRDS(brt1, file = here("data", "processed_data", "brt", "full_data.rds"))
saveRDS(brt2, file = here("data", "processed_data", "brt", "clim_only_data.rds"))
saveRDS(brt3, file = here("data", "processed_data", "brt", "train_data.rds"))
```

```{r}
#gbm.plot(brt1, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = )
```


```{r}
# test_preds <- gbm.predict.grids(brt3, new.dat = pres_abs_df_test)
# pres_abs_df_test %<>% add_column(preds = test_preds)

```




```{r}
para_class <- readRDS(here("data", "processed_data", "para_class.rds"))
pres_abs_df %<>% left_join(., para_class, by="para")
#pres_abs_df %<>% dplyr::select(-c(avail_hosts, effort)) 
```

```{r}
pres_abs_without_host <- pres_abs_df %>% dplyr::select(-c(avail_hosts, effort)) 

pres_abs_without_host %<>%
  filter(ParType %in% c("Arthropod", "Helminth", "Virus", "Bacteria", "Protozoa")) %>%
  mutate(ParType = as.factor(ParType),
         ParMacroMicro = as.factor(ParMacroMicro),
         mode = as.factor(mode),
         spec_bin = as.factor(spec_bin),
         prev_bin = as.factor(prev_bin),
         int_bin = as.factor(int_bin))

train <- sample(1:nrow(pres_abs_without_host), nrow(pres_abs_without_host) * 0.8)
test <- pres_abs_df %>% mutate(row_num = rownames(.)) %>% filter(!row_num %in% train) %>% dplyr::select(row_num)
test <- as.integer(test$row_num)

pres_abs_without_host_train <- pres_abs_without_host[train, ]
pres_abs_without_host_test <- pres_abs_without_host[test, ]

brt4 <- gbm.step(as.data.frame(pres_abs_without_host_train), 
              gbm.x = c(4:ncol(pres_abs_without_host_train)), 
              gbm.y = 3, 
              family = "bernoulli", 
              tree.complexity = 4, 
              learning.rate = 0.05, 
              bag.fraction = 0.5)
```


```{r}
#saveRDS(brt4, file = here("data", "processed_data", "brt", "brt4_lr0.01.rds"))
#saveRDS(brt4, file = here("data", "processed_data", "brt", "brt4_lr0.05.rds"))
#saveRDS(brt4, file = here("data", "processed_data", "brt", "brt4_lesspartypes_lr0.05.rds"))
summary(brt4)
gbm.plot(brt4, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T)
```


```{r}
brt4_names <- brt4$var.names
brt4_partype_no <- which(brt4_names %in% c("ParType"))
gbm.plot(brt4, variable.no = brt4_partype_no, plot.layout=c(1, 1), write.title = FALSE)
```










