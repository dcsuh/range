---
title: "brt"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = F}
library(here)
library(tidyverse)
library(magrittr)

source(here("elith_tutorial", "brt.functions.R"))

set.seed(8878896)
```

```{r}
gmpd_ecoreg_psr <- readRDS(here("data", "processed_data", "gmpd_ecoreg_psr.rds"))

worldclim_mean <- readRDS(here("data", "processed_data", "worldclim_mean.rds"))

prop_max_rich <- readRDS(here("data", "processed_data", "ratios", "prop_max_rich_ecoreg.rds"))

gmpd_ecoreg_effort <- readRDS(here("data", "processed_data", "gmpd_ecoreg_effort.rds"))
```

```{r}
gmpd_ecoreg_effort %<>% rename(effort=n,
                               ecoreg=ECO_CODE)
```

```{r}
gmpd_ecoreg_psr %<>% left_join(., gmpd_ecoreg_effort)
gmpd_ecoreg_psr %<>% left_join(., worldclim_mean, by="ecoreg")

gmpd_ecoreg_psr %<>% dplyr::select(-c(na))


```

```{r, eval=F}
brt <- gbm.step(data = as.data.frame(gmpd_ecoreg_psr), 
                gbm.x = 3:ncol(gmpd_ecoreg_psr), 
                gbm.y = 1, 
                family = "poisson", 
                tree.complexity = 5, 
                learning.rate = 0.004, 
                bag.fraction = 0.5)
```

```{r, eval=F}
summary(brt)

gbm.plot(brt, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T)
```






```{r}
prop_max_rich %<>% left_join(., gmpd_ecoreg_effort)
prop_max_rich %<>% left_join(., worldclim_mean)

prop_max_rich %<>% filter(!is.na(effort) & ratio<=1) %>% dplyr::select(-c(na, para.x, para.y))


```

```{r, eval=F}
brt_ratio <- gbm.step(as.data.frame(prop_max_rich), 
              gbm.x = c(2,4:ncol(gmpd_ecoreg_psr)), 
              gbm.y = 3, 
              family = "", 
              tree.complexity = 5, 
              learning.rate = 0.004, 
              bag.fraction = 0.5)
```

#try another way

Is the parasite present in an ecoreg?
 - worldclim variables
 - parasite classifications
 - number of viable hosts in that ecoreg
 
 - each row is one parasite in on ecoregion and whether or not they are present

host_para_mat is all of the host-parasite associations from gmpd
ecoreg_host_mat is all of the host presences in ecoregions

ecoreg_para_mat is every parasite's actual ecoregion presence as estimated by host_para_mat and ecoreg_host_mat
null_para_df is every parasite's possible presence in an ecoregion due to host presence

```{r}
host_para_mat <- readRDS(here("data", "processed_data", "para_mat.rds"))
ecoreg_host_mat <- readRDS(here("data", "processed_data", "ecoreg_mat.rds"))
ecoreg_para_mat <- readRDS(here("data", "processed_data", "ecoreg_para_mat.rds"))
null_para_df <- readRDS(here("data", "processed_data", "null_para_df.rds"))
```

```{r}
ecoreg_names <- colnames(ecoreg_para_mat[2:ncol(ecoreg_para_mat)])
ecoreg_para_long <- ecoreg_para_mat %>% 
  pivot_longer(cols = all_of(ecoreg_names)) %>%
  filter(value==1) %>%
  rename(pres = value,
         para = ParasiteCorrectedName)
```

ecoreg_para_long is every ecoregion where the parasite is actually present

```{r}
pres_abs_df <- null_para_df %>% 
  left_join(., ecoreg_para_long, by = c("para", "name")) %>%
  mutate(pres = replace_na(pres, 0))

pres_abs_full <- pres_abs_df #presences are duplicated here because sometimes a parasite is present in an ecoregion due to multiple hosts

hosts_available <- pres_abs_df %>% 
  dplyr::select(sci_name, para, name) %>% 
  group_by(para, name) %>% 
  summarize(avail_hosts = n())

pres_abs_df %<>% dplyr::select(para, name, pres) %>% distinct() #need to do this because parasite could be present in an ecoregion due to multiple hosts

pres_abs_df %<>% left_join(., hosts_available)
```



```{r}
pres_abs_df %<>% rename(ecoreg = name)
pres_abs_df %<>% left_join(., worldclim_mean, by="ecoreg")
pres_abs_df %<>% left_join(., gmpd_ecoreg_effort, by="ecoreg")
```

```{r}
pres_abs_df %<>% drop_na() %>% dplyr::select(-c(na))
```

```{r}
train <- sample(1:nrow(pres_abs_df), nrow(pres_abs_df) * 0.8)
test <- pres_abs_df %>% mutate(row_num = rownames(.)) %>% filter(!row_num %in% train) %>% dplyr::select(row_num)
test <- as.integer(test$row_num)

pres_abs_df_train <- pres_abs_df[train, ]
pres_abs_df_test <- pres_abs_df[test, ]
```


```{r, eval=F}
brt1 <- gbm.step(as.data.frame(pres_abs_df), 
              gbm.x = c(4:ncol(pres_abs_df)), 
              gbm.y = 3, 
              family = "bernoulli", 
              tree.complexity = 4, 
              learning.rate = 0.01, 
              bag.fraction = 0.5)

brt2 <- gbm.step(as.data.frame(pres_abs_df), 
              gbm.x = c(5:(ncol(pres_abs_df)-1)), 
              gbm.y = 3, 
              family = "bernoulli", 
              tree.complexity = 4, 
              learning.rate = 0.01, 
              bag.fraction = 0.5)

brt3 <- gbm.step(as.data.frame(pres_abs_df_train), 
              gbm.x = c(4:ncol(pres_abs_df_train)), 
              gbm.y = 3, 
              family = "bernoulli", 
              tree.complexity = 4, 
              learning.rate = 0.01, 
              bag.fraction = 0.5)
```

```{r, eval=F}
summary(brt1)
summary(brt2)
summary(brt3)

saveRDS(brt1, file = here("data", "processed_data", "brt", "full_data.rds"))
saveRDS(brt2, file = here("data", "processed_data", "brt", "clim_only_data.rds"))
saveRDS(brt3, file = here("data", "processed_data", "brt", "train_data.rds"))
```

```{r}
#gbm.plot(brt1, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T, main = )
```


```{r}
# test_preds <- gbm.predict.grids(brt3, new.dat = pres_abs_df_test)
# pres_abs_df_test %<>% add_column(preds = test_preds)

```




```{r}
para_class <- readRDS(here("data", "processed_data", "para_class.rds"))
pres_abs_df %<>% left_join(., para_class, by="para")
#pres_abs_df %<>% dplyr::select(-c(avail_hosts, effort)) 
```


```{r}
pres_abs_df %<>%
  filter(ParType %in% c("Arthropod", "Helminth", "Virus", "Bacteria", "Protozoa")) %>%
  mutate(ParType = as.factor(ParType),
         ParMacroMicro = as.factor(ParMacroMicro),
         mode = as.factor(mode),
         spec_bin = as.factor(spec_bin),
         prev_bin = as.factor(prev_bin),
         int_bin = as.factor(int_bin))

train <- sample(1:nrow(pres_abs_df), nrow(pres_abs_df) * 0.8)
test <- pres_abs_df %>% mutate(row_num = rownames(.)) %>% filter(!row_num %in% train) %>% dplyr::select(row_num)
test <- as.integer(test$row_num)

pres_abs_df_train <- pres_abs_df[train, ]
pres_abs_df_test <- pres_abs_df[test, ]
```


```{r, eval=F}
brt_all <- gbm.step(as.data.frame(pres_abs_df_train), 
              gbm.x = c(4:ncol(pres_abs_df_train)), 
              gbm.y = 3, 
              family = "bernoulli", 
              tree.complexity = 4, 
              learning.rate = 0.05, 
              bag.fraction = 0.5)

saveRDS(brt_all, file = here("data", "processed_data", "brt", "brt_all_lr0.05.rds"))
```


```{r}
brt_all <- readRDS(file = here("data", "processed_data", "brt", "brt_all_lr0.05.rds"))
summary(brt_all)
gbm.plot(brt_all, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T)
```



```{r}
pres_abs_without_host <- pres_abs_df %>% dplyr::select(-c(avail_hosts, effort)) 

pres_abs_without_host %<>%
  filter(ParType %in% c("Arthropod", "Helminth", "Virus", "Bacteria", "Protozoa")) %>%
  mutate(ParType = as.factor(ParType),
         ParMacroMicro = as.factor(ParMacroMicro),
         mode = as.factor(mode),
         spec_bin = as.factor(spec_bin),
         prev_bin = as.factor(prev_bin),
         int_bin = as.factor(int_bin))

train <- sample(1:nrow(pres_abs_without_host), nrow(pres_abs_without_host) * 0.8)
test <- pres_abs_df %>% mutate(row_num = rownames(.)) %>% filter(!row_num %in% train) %>% dplyr::select(row_num)
test <- as.integer(test$row_num)

pres_abs_without_host_train <- pres_abs_without_host[train, ]
pres_abs_without_host_test <- pres_abs_without_host[test, ]
```


```{r, eval=F}
brt_partype <- gbm.step(as.data.frame(pres_abs_without_host_train), 
              gbm.x = c(4:ncol(pres_abs_without_host_train)), 
              gbm.y = 3, 
              family = "bernoulli", 
              tree.complexity = 4, 
              learning.rate = 0.05, 
              bag.fraction = 0.5)
#saveRDS(brt_partype, file = here("data", "processed_data", "brt", "brt_partype_lr0.05.rds"))
```




```{r}
brt_partype <- readRDS(file = here("data", "processed_data", "brt", "brt_partype_lr0.05.rds"))
summary(brt_partype)
gbm.plot(brt_partype, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T)
```



```{r}
pres_abs_without_host <- pres_abs_df %>% dplyr::select(-c(avail_hosts, effort, ParType)) 

pres_abs_without_host %<>%
  #filter(ParType %in% c("Arthropod", "Helminth", "Virus", "Bacteria", "Protozoa")) %>%
  mutate(ParMacroMicro = as.factor(ParMacroMicro),
         mode = as.factor(mode),
         spec_bin = as.factor(spec_bin),
         prev_bin = as.factor(prev_bin),
         int_bin = as.factor(int_bin))

train <- sample(1:nrow(pres_abs_without_host), nrow(pres_abs_without_host) * 0.8)
test <- pres_abs_df %>% mutate(row_num = rownames(.)) %>% filter(!row_num %in% train) %>% dplyr::select(row_num)
test <- as.integer(test$row_num)

pres_abs_without_host_train <- pres_abs_without_host[train, ]
pres_abs_without_host_test <- pres_abs_without_host[test, ]

# saveRDS(pres_abs_without_host_train, file = here("data", "processed_data", "brt", "brt4_train_data.rds"))
# saveRDS(pres_abs_without_host_test, file = here("data", "processed_data", "brt", "brt4_test_data.rds"))
```


```{r, eval=F}
brt4 <- gbm.step(as.data.frame(pres_abs_without_host_train), 
              gbm.x = c(4:ncol(pres_abs_without_host_train)), 
              gbm.y = 3, 
              family = "bernoulli", 
              tree.complexity = 4, 
              learning.rate = 0.05, 
              bag.fraction = 0.5)

#saveRDS(brt4, file = here("data", "processed_data", "brt", "brt4_nopartype_lr0.05.rds"))
```



```{r, eval=F}
brt4 <- readRDS(file = here("data", "processed_data", "brt", "brt4_nopartype_lr0.05.rds"))
summary(brt4)
gbm.plot(brt4, n.plots=6, plot.layout=c(2, 3), write.title = FALSE, common.scale = T)
```




BIO1 = Annual Mean Temperature

BIO2 = Mean Diurnal Range (Mean of monthly (max temp - min temp))

BIO3 = Isothermality (BIO2/BIO7) (×100)

BIO4 = Temperature Seasonality (standard deviation ×100)

BIO5 = Max Temperature of Warmest Month

BIO6 = Min Temperature of Coldest Month

BIO7 = Temperature Annual Range (BIO5-BIO6)

BIO8 = Mean Temperature of Wettest Quarter

BIO9 = Mean Temperature of Driest Quarter

BIO10 = Mean Temperature of Warmest Quarter

BIO11 = Mean Temperature of Coldest Quarter

BIO12 = Annual Precipitation

BIO13 = Precipitation of Wettest Month

BIO14 = Precipitation of Driest Month

BIO15 = Precipitation Seasonality (Coefficient of Variation)

BIO16 = Precipitation of Wettest Quarter

BIO17 = Precipitation of Driest Quarter

BIO18 = Precipitation of Warmest Quarter

BIO19 = Precipitation of Coldest Quarter



```{r}
preds <- predict.gbm(brt4, pres_abs_without_host_test, n.trees = brt4$gbm.call$best.trees, type = "response")
tmp <- cbind(pres_abs_without_host_test$pres, preds)
pres <- tmp[tmp[,1]==1, 2]
abs <- tmp[tmp[,1]==0, 2]
e <- evaluate(p = pres, a = abs)
e

roc_test <- pROC::roc(pres_abs_without_host_test$pres, preds)
plot.roc(roc_test,
         xlim=c(1,0))
```

```{r}
preds <- predict.gbm(brt_all, pres_abs_df_test, n.trees = brt_all$gbm.call$best.trees, type = "response")
tmp <- cbind(pres_abs_df_test$pres, preds)
pres <- tmp[tmp[,1]==1, 2]
abs <- tmp[tmp[,1]==0, 2]
e <- evaluate(p = pres, a = abs)
e

roc_test <- pROC::roc(pres_abs_df_test$pres, preds)
plot.roc(roc_test,
         xlim=c(1,0))
```









