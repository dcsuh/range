---
title: "prop_filled"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(magrittr)
library(janitor)
```

what are the proportions of ecoregions filled by a parasite given it's host range
break it down by (1) parasite type, (2) transmission mode, (3) host specificity, (4) high vs. low prevalence, (5) high vs. low intensity
```{r}
host_para_mat <- readRDS(here("data", "processed_data", "para_mat.rds"))
ecoreg_host_mat <- readRDS(here("data", "processed_data", "ecoreg_mat.rds"))
ecoreg_para_mat <- readRDS(here("data", "processed_data", "ecoreg_para_mat.rds"))
null_para_df <- readRDS(here("data", "processed_data", "null_para_df.rds"))
gmpd_ecoreg_effort <- readRDS(here("data", "processed_data", "gmpd_ecoreg_effort.rds"))

gmpd <- read_csv(here("data", "GMPD", "GMPD_main.csv"))
gmpd_traits <- read_csv(here("data", "GMPD", "GMPD_parasite_traits.csv"))

```
# Add column for parasite type
```{r}
gmpd_type <- gmpd %>% dplyr::select(ParasiteCorrectedName, ParType) %>% distinct()

par_type_index <- tibble(ParType = c("Virus", "Bacteria", "Protozoa", "Prion", "Fungus", "Helminth", "Arthropod"),
                         ParMacroMicro = c("micro", "micro", "micro", "micro", "micro", "macro", "macro"))

gmpd_type %<>% left_join(., par_type_index)

gmpd_type %<>% rename(., para = ParasiteCorrectedName)
```

```{r}
para_names <- null_para_df %>% dplyr::select(para) %>% distinct()
gmpd_type %<>% filter(para %in% para_names$para)
```

There are some parasites called "not identified to genus" and these are different parasites so are creating issues when joining dataframes
```{r}
gmpd_type %<>% filter(!para == "not identified to genus")
null_para_df %<>% filter(!para == "not identified to genus")

```


```{r}
null_para_df %<>% left_join(., gmpd_type)
```

# Add column for transmission mode
```{r}
gmpd_traits %<>% mutate(mode = 
                           ifelse(close == TRUE | nonclose == TRUE,
                                  "direct",
                                  "indirect")) %>%
  filter(!is.na(mode)) #remove parasites without mode data

gmpd_traits %<>% rename(para=ParasiteCorrectedName) %>% dplyr::select(para, mode)
```


```{r}
null_para_df %<>% left_join(., gmpd_traits)
```



# Add column for host specificity
```{r}
load(file=here("data", "GMPD", "get_nri.Rda"))
nri %<>% rownames_to_column(., var = "para")

nri %<>% 
  filter(!is.na(mpd.obs.z)) %>%
  mutate(spec_bin = ifelse(
    mpd.obs.z<median(mpd.obs.z), #class determined above or below median
    "specialist",
    "generalist"
  ))

tabyl(nri$spec_bin)

nri %<>% dplyr::select(para, spec_bin)

null_para_df %<>% left_join(., nri)
```


# Add column for prevalence
```{r}
gmpd_prev <- gmpd %>% 
  dplyr::select(ParasiteCorrectedName, Prevalence) %>%
  filter(!is.na(Prevalence)) %>%
  group_by(ParasiteCorrectedName) %>%
  summarize(Prevalence=mean(Prevalence)) %>% #get average prevalence
  mutate(prev_bin = ifelse(
    Prevalence > median(Prevalence), #above or below median
    "high_prevalence",
    "low_prevalence"
  ))

tabyl(gmpd_prev$prev_bin)

gmpd_prev %<>% rename(para = ParasiteCorrectedName) %>% dplyr::select(para, prev_bin)

null_para_df %<>% left_join(., gmpd_prev)
```



# Add column for intensity
```{r}
gmpd_int <- gmpd %>%
  dplyr::select(ParasiteCorrectedName, Intensity) %>%
  mutate(Intensity = as.numeric(Intensity)) %>% #some intensity measures included characters to indicate exponent or range. these are removed for now
  filter(!is.na(Intensity)) %>%
  filter(Intensity>0) %>% #some intensity measures were 0. these were removed
  group_by(ParasiteCorrectedName) %>%
  summarize(Intensity = mean(Intensity)) %>% #get average intensity
  mutate(int_bin = ifelse(
    Intensity > median(Intensity), #above or below median
    "high_intensity",
    "low_intensity"
  ))

tabyl(gmpd_int$int_bin)

gmpd_int %<>% rename(para = ParasiteCorrectedName) %>% dplyr::select(para, int_bin)

null_para_df %<>% left_join(., gmpd_int)
```


# plotting function





# macro micro

```{r}

```


# transmission mode




# specialism




# prevalence




# intensity






```{r}
para_ecoregs <- null_para_df %>% group_by(para) %>% distinct() %>% summarize(tot_ecoreg = n())
```

```{r}
gmpd_para_ecoreg <- ecoreg_para_mat %>% 
  pivot_longer(cols=2:379) %>% 
  filter(value==1) %>%
  group_by(ParasiteCorrectedName) %>%
  distinct() %>%
  summarize(filled_ecoreg = n()) %>%
  rename(para = ParasiteCorrectedName)
  
```






