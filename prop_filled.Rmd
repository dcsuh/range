---
title: "prop_filled"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(magrittr)
library(janitor)
```


# Notes

Why are there positive ratios when we are dividing observed in GMPD over max possible richness per ecoregion?
 - Already tried to restrict data to those in native range but this doesn't fix it
    - may need to ensure that parasite presence is only counted in GMPD if it is within host IUCN range
    - how often does parasite presence in ecoregion per host IUCN data actually match up with gmpd data?
       - I should be able to do this using geoms




# Summary

What is the actual PSR per ecoregion compared to the maximum PSR per ecoregion across different parasite groupings: (1) parasite type, (2) transmission mode, (3) host specificity, (4) high vs. low prevalence, (5) high vs. low intensity?

Overall method: 
Create two evenly sized groups divided by some feature of the parasite
Measure actual PSR per ecoregion for each group
Measure maximum PSR per ecoregion assuming full host filling
Compare ratio of actual:maximum for all ecoregions across feature


```{r}
host_para_mat <- readRDS(here("data", "processed_data", "para_mat.rds"))
ecoreg_host_mat <- readRDS(here("data", "processed_data", "ecoreg_mat.rds"))
ecoreg_para_mat <- readRDS(here("data", "processed_data", "ecoreg_para_mat.rds"))
null_para_df <- readRDS(here("data", "processed_data", "null_para_df.rds"))
gmpd_ecoreg_effort <- readRDS(here("data", "processed_data", "gmpd_ecoreg_effort.rds"))

gmpd <- read_csv(here("data", "GMPD", "GMPD_main.csv"))
gmpd_traits <- read_csv(here("data", "GMPD", "GMPD_parasite_traits.csv"))

```
```{r}
gmpd %<>% filter(NativeRange=="Yes")
#gmpd %<>% filter(NativeRange!="No" | is.na(NativeRange))
```


# Add column for parasite type
```{r}
gmpd_type <- gmpd %>% dplyr::select(ParasiteCorrectedName, ParType) %>% distinct()

par_type_index <- tibble(ParType = c("Virus", "Bacteria", "Protozoa", "Prion", "Fungus", "Helminth", "Arthropod"),
                         ParMacroMicro = c("micro", "micro", "micro", "micro", "micro", "macro", "macro"))

gmpd_type %<>% left_join(., par_type_index)

gmpd_type %<>% rename(., para = ParasiteCorrectedName)
```

```{r}
para_names <- null_para_df %>% dplyr::select(para) %>% distinct()
gmpd_type %<>% filter(para %in% para_names$para)
```

There are some parasites called "not identified to genus" and these are different parasites so are creating issues when joining dataframes
```{r}
gmpd_type %<>% filter(!para == "not identified to genus")
null_para_df %<>% filter(!para == "not identified to genus")

```


```{r}
null_para_df %<>% left_join(., gmpd_type)
```

# Add column for transmission mode
```{r}
gmpd_traits %<>% mutate(mode = 
                           ifelse(close == TRUE | nonclose == TRUE,
                                  "direct",
                                  "indirect")) %>%
  filter(!is.na(mode)) #remove parasites without mode data

gmpd_traits %<>% rename(para=ParasiteCorrectedName) %>% dplyr::select(para, mode)
```


```{r}
null_para_df %<>% left_join(., gmpd_traits)
```



# Add column for host specificity
```{r}
load(file=here("data", "GMPD", "get_nri.Rda"))
nri %<>% rownames_to_column(., var = "para")

nri %<>% 
  filter(!is.na(mpd.obs.z)) %>%
  mutate(spec_bin = ifelse(
    mpd.obs.z<median(mpd.obs.z), #class determined above or below median
    "specialist",
    "generalist"
  ))

tabyl(nri$spec_bin)

nri %<>% dplyr::select(para, spec_bin)

null_para_df %<>% left_join(., nri)
```


# Add column for prevalence
```{r}
gmpd_prev <- gmpd %>% 
  dplyr::select(ParasiteCorrectedName, Prevalence) %>%
  filter(!is.na(Prevalence)) %>%
  group_by(ParasiteCorrectedName) %>%
  summarize(Prevalence=mean(Prevalence)) %>% #get average prevalence
  mutate(prev_bin = ifelse(
    Prevalence > median(Prevalence), #above or below median
    "high_prevalence",
    "low_prevalence"
  ))

tabyl(gmpd_prev$prev_bin)

gmpd_prev %<>% rename(para = ParasiteCorrectedName) %>% dplyr::select(para, prev_bin)

null_para_df %<>% left_join(., gmpd_prev)
```



# Add column for intensity
```{r}
gmpd_int <- gmpd %>%
  dplyr::select(ParasiteCorrectedName, Intensity) %>%
  mutate(Intensity = as.numeric(Intensity)) %>% #some intensity measures included characters to indicate exponent or range. these are removed for now
  filter(!is.na(Intensity)) %>%
  filter(Intensity>0) %>% #some intensity measures were 0. these were removed
  group_by(ParasiteCorrectedName) %>%
  summarize(Intensity = mean(Intensity)) %>% #get average intensity
  mutate(int_bin = ifelse(
    Intensity > median(Intensity), #above or below median
    "high_intensity",
    "low_intensity"
  ))

tabyl(gmpd_int$int_bin)

gmpd_int %<>% rename(para = ParasiteCorrectedName) %>% dplyr::select(para, int_bin)

null_para_df %<>% left_join(., gmpd_int)
```
# proportion filled function

```{r}
get_richness_df <- function(para_mat){
  para_rich <- colSums(para_mat[2:ncol(para_mat)])
  
  tmp <- tibble(para = para_rich, ecoreg = names(para_rich))
  
  tmp %>% left_join(., host_rich_df) %>% replace(is.na(.), 0)
}
```

```{r}
host_rich <- colSums(ecoreg_host_mat[2:ncol(ecoreg_host_mat)])
host_rich_df <- tibble(ecoreg = names(host_rich), host = host_rich)
```

```{r}
actual_para_rich <- get_richness_df(ecoreg_para_mat)
```

```{r}
make_mat <- function(para_df){
para_df %>% 
  dplyr::select(c(para, name, value)) %>% 
  distinct() %>% 
  pivot_wider(., names_from = name, values_from = value) %>%
  replace(is.na(.), 0)
}
```


# plotting function





# actual ecoreg para mat with more attributes

```{r}
ecoreg_para_mat_vars <- ecoreg_para_mat %>% rename(para = ParasiteCorrectedName) %>% 
  left_join(., gmpd_type) %>%
  left_join(., gmpd_traits) %>%
  left_join(., nri) %>%
  left_join(., gmpd_prev) %>%
  left_join(., gmpd_int)

group_vars <- c("ParType", "ParMacroMicro", "mode", "spec_bin", "prev_bin", "int_bin")
```



```{r}
get_ratios <- function(data, VarName){

vars <- data %>% dplyr::select(VarName) %>% distinct() %>% filter(!is.na(.))
  
  
actual_para_first <- ecoreg_para_mat_vars %>% filter(!!sym(VarName) == vars[[1,1]]) %>%
  dplyr::select(-group_vars) %>% get_richness_df(.)
actual_para_second <- ecoreg_para_mat_vars %>% filter(!!sym(VarName) == vars[[2,1]]) %>%
  dplyr::select(-group_vars) %>% get_richness_df(.)

max_rich_first <- null_para_df %>% filter(!!sym(VarName) == vars[[1,1]]) %>% make_mat(.) %>% get_richness_df(.) 
max_rich_second <- null_para_df %>% filter(!!sym(VarName) == vars[[2,1]]) %>% make_mat(.) %>% get_richness_df(.) 



max_rich_first %<>% left_join(., actual_para_first, by=c("ecoreg", "host")) %>% mutate(binary = vars[[1,1]])
max_rich_second %<>% left_join(., actual_para_second, by=c("ecoreg", "host")) %>% mutate(binary = vars[[2,1]])

para_binary_rich <- rbind(max_rich_first, max_rich_second)

para_binary_rich %<>% mutate(ratio = para.y/para.x) %>% filter(!is.na(ratio))

return(para_binary_rich)
}
```


```{r}
type_ratios <- get_ratios(ecoreg_para_mat_vars, "ParMacroMicro")
mode_ratios <- get_ratios(ecoreg_para_mat_vars, "mode")
spec_ratios <- get_ratios(ecoreg_para_mat_vars, "spec_bin")
prev_ratios <- get_ratios(ecoreg_para_mat_vars, "prev_bin")
int_ratios <- get_ratios(ecoreg_para_mat_vars, "int_bin")
```


```{r}
type_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_boxplot() + geom_jitter()
mode_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_boxplot() + geom_jitter()
spec_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_boxplot() + geom_jitter()
prev_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_boxplot() + geom_jitter()
int_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_boxplot() + geom_jitter()
```
```{r}
type_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_violin()
mode_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_violin()
spec_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_violin()
prev_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_violin()
int_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_violin()

```


non-parametric, two-tailed test

```{r}
wilcox.test(ratio ~ binary, data = type_ratios %>% filter(ratio<1))
wilcox.test(ratio ~ binary, data = mode_ratios %>% filter(ratio<1))
wilcox.test(ratio ~ binary, data = spec_ratios %>% filter(ratio<1))
wilcox.test(ratio ~ binary, data = prev_ratios %>% filter(ratio<1))
wilcox.test(ratio ~ binary, data = int_ratios %>% filter(ratio<1))
```

Paired tests

```{r}
get_pairs <- function(data){
  vars <- data %>% dplyr::select(binary) %>% distinct() %>% filter(!is.na(.))
  
  first <- data %>% filter(binary == vars[[1,1]]) %>% dplyr::select(ecoreg, binary, ratio)
  second <- data %>% filter(binary == vars[[2,1]]) %>% dplyr::select(ecoreg, binary, ratio)
  
  output <- left_join(first, second, by="ecoreg")
  
  output %<>% mutate(diff = ratio.x-ratio.y) %>% filter(!is.na(diff))
  
  return(output)
}
```

```{r}
paired_type <- get_pairs(type_ratios)
paired_mode <- get_pairs(mode_ratios)
paired_spec <- get_pairs(spec_ratios)
paired_prev <- get_pairs(prev_ratios)
paired_int <- get_pairs(int_ratios)
```


Each point is an ecoregion and the values correspond to the proportion of max PSR each ecoregion has when broken down into either grouping from a parasite feature.

```{r}
paired_type %>% filter(ratio.x < 1 & ratio.y < 1) %>% 
  ggplot(., aes(x=ratio.x, y=ratio.y)) + 
  geom_point() + 
  geom_abline(intercept=0) + 
  labs(title = "macro vs. micro",
       x = "micro",
       y = "macro")

paired_mode %>% filter(ratio.x < 1 & ratio.y < 1) %>% 
  ggplot(., aes(x=ratio.x, y=ratio.y)) + 
  geom_point() + 
  geom_abline(intercept=0) + 
  labs(title = "direct vs. indirect",
       x = "direct",
       y = "indirect")

paired_spec %>% filter(ratio.x < 1 & ratio.y < 1) %>% 
  ggplot(., aes(x=ratio.x, y=ratio.y)) + 
  geom_point() + 
  geom_abline(intercept=0) + 
  labs(title = "specialist vs. generalist",
       x = "specialist",
       y = "generalist")

paired_prev %>% filter(ratio.x < 1 & ratio.y < 1) %>% 
  ggplot(., aes(x=ratio.x, y=ratio.y)) + 
  geom_point() + 
  geom_abline(intercept=0) + 
  labs(title = "low prev vs. high prev",
       x = "low prev",
       y = "high prev")

paired_int %>% filter(ratio.x < 1 & ratio.y < 1) %>% 
  ggplot(., aes(x=ratio.x, y=ratio.y)) + 
  geom_point() + 
  geom_abline(intercept=0) + 
  labs(title = "high int vs. low int",
       x = "high int",
       y = "low int")
```



paired, non-parametric, two-tailed
```{r}
mod <- wilcox.test(paired_type$ratio.x, paired_type$ratio.y, paired=TRUE)
wilcox.test(paired_mode$ratio.x, paired_mode$ratio.y, paired=TRUE)
wilcox.test(paired_spec$ratio.x, paired_spec$ratio.y, paired=TRUE)
wilcox.test(paired_prev$ratio.x, paired_prev$ratio.y, paired=TRUE)
wilcox.test(paired_int$ratio.x, paired_int$ratio.y, paired=TRUE)
```


paired, non-parametric, one-tailed
```{r}
#Is prop filled by micro (x) greater than macro (y)?
wilcox.test(paired_type$ratio.x, paired_type$ratio.y, paired=TRUE, alternative = "greater")

#Is prop filled by direct (x) less than indirect (y)?
wilcox.test(paired_mode$ratio.x, paired_mode$ratio.y, paired=TRUE, alternative = "less")

#Is prop filled by specialist (x) greater than generalist (y)?
wilcox.test(paired_spec$ratio.x, paired_spec$ratio.y, paired=TRUE, alternative = "greater")

#Is prop filled by low prevalence (x) less than high prevalence (y)?
wilcox.test(paired_prev$ratio.x, paired_prev$ratio.y, paired=TRUE, alternative = "less")

#Is prop filled by high intensity (x) less than low intensity (y)?
wilcox.test(paired_int$ratio.x, paired_int$ratio.y, paired=TRUE, alternative = "less")
```







