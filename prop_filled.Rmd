---
title: "prop_filled"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(magrittr)
library(janitor)
```


# Notes

Why are there positive ratios when we are dividing observed in GMPD over max possible richness per ecoregion?
 - Already tried to restrict data to those in native range but this doesn't fix it
    - may need to ensure that parasite presence is only counted in GMPD if it is within host IUCN range
    - how often does parasite presence in ecoregion per host IUCN data actually match up with gmpd data?
       - I should be able to do this using geoms




what are the proportions of ecoregions filled by a parasite given it's host range
break it down by (1) parasite type, (2) transmission mode, (3) host specificity, (4) high vs. low prevalence, (5) high vs. low intensity
```{r}
host_para_mat <- readRDS(here("data", "processed_data", "para_mat.rds"))
ecoreg_host_mat <- readRDS(here("data", "processed_data", "ecoreg_mat.rds"))
ecoreg_para_mat <- readRDS(here("data", "processed_data", "ecoreg_para_mat.rds"))
null_para_df <- readRDS(here("data", "processed_data", "null_para_df.rds"))
gmpd_ecoreg_effort <- readRDS(here("data", "processed_data", "gmpd_ecoreg_effort.rds"))

gmpd <- read_csv(here("data", "GMPD", "GMPD_main.csv"))
gmpd_traits <- read_csv(here("data", "GMPD", "GMPD_parasite_traits.csv"))

```
```{r}
gmpd %<>% filter(NativeRange=="Yes")
#gmpd %<>% filter(NativeRange!="No" | is.na(NativeRange))
```


# Add column for parasite type
```{r}
gmpd_type <- gmpd %>% dplyr::select(ParasiteCorrectedName, ParType) %>% distinct()

par_type_index <- tibble(ParType = c("Virus", "Bacteria", "Protozoa", "Prion", "Fungus", "Helminth", "Arthropod"),
                         ParMacroMicro = c("micro", "micro", "micro", "micro", "micro", "macro", "macro"))

gmpd_type %<>% left_join(., par_type_index)

gmpd_type %<>% rename(., para = ParasiteCorrectedName)
```

```{r}
para_names <- null_para_df %>% dplyr::select(para) %>% distinct()
gmpd_type %<>% filter(para %in% para_names$para)
```

There are some parasites called "not identified to genus" and these are different parasites so are creating issues when joining dataframes
```{r}
gmpd_type %<>% filter(!para == "not identified to genus")
null_para_df %<>% filter(!para == "not identified to genus")

```


```{r}
null_para_df %<>% left_join(., gmpd_type)
```

# Add column for transmission mode
```{r}
gmpd_traits %<>% mutate(mode = 
                           ifelse(close == TRUE | nonclose == TRUE,
                                  "direct",
                                  "indirect")) %>%
  filter(!is.na(mode)) #remove parasites without mode data

gmpd_traits %<>% rename(para=ParasiteCorrectedName) %>% dplyr::select(para, mode)
```


```{r}
null_para_df %<>% left_join(., gmpd_traits)
```



# Add column for host specificity
```{r}
load(file=here("data", "GMPD", "get_nri.Rda"))
nri %<>% rownames_to_column(., var = "para")

nri %<>% 
  filter(!is.na(mpd.obs.z)) %>%
  mutate(spec_bin = ifelse(
    mpd.obs.z<median(mpd.obs.z), #class determined above or below median
    "specialist",
    "generalist"
  ))

tabyl(nri$spec_bin)

nri %<>% dplyr::select(para, spec_bin)

null_para_df %<>% left_join(., nri)
```


# Add column for prevalence
```{r}
gmpd_prev <- gmpd %>% 
  dplyr::select(ParasiteCorrectedName, Prevalence) %>%
  filter(!is.na(Prevalence)) %>%
  group_by(ParasiteCorrectedName) %>%
  summarize(Prevalence=mean(Prevalence)) %>% #get average prevalence
  mutate(prev_bin = ifelse(
    Prevalence > median(Prevalence), #above or below median
    "high_prevalence",
    "low_prevalence"
  ))

tabyl(gmpd_prev$prev_bin)

gmpd_prev %<>% rename(para = ParasiteCorrectedName) %>% dplyr::select(para, prev_bin)

null_para_df %<>% left_join(., gmpd_prev)
```



# Add column for intensity
```{r}
gmpd_int <- gmpd %>%
  dplyr::select(ParasiteCorrectedName, Intensity) %>%
  mutate(Intensity = as.numeric(Intensity)) %>% #some intensity measures included characters to indicate exponent or range. these are removed for now
  filter(!is.na(Intensity)) %>%
  filter(Intensity>0) %>% #some intensity measures were 0. these were removed
  group_by(ParasiteCorrectedName) %>%
  summarize(Intensity = mean(Intensity)) %>% #get average intensity
  mutate(int_bin = ifelse(
    Intensity > median(Intensity), #above or below median
    "high_intensity",
    "low_intensity"
  ))

tabyl(gmpd_int$int_bin)

gmpd_int %<>% rename(para = ParasiteCorrectedName) %>% dplyr::select(para, int_bin)

null_para_df %<>% left_join(., gmpd_int)
```
# proportion filled function

```{r}
get_richness_df <- function(para_mat){
  para_rich <- colSums(para_mat[2:ncol(para_mat)])
  
  tmp <- tibble(para = para_rich, ecoreg = names(para_rich))
  
  tmp %>% left_join(., host_rich_df) %>% replace(is.na(.), 0)
}
```

```{r}
host_rich <- colSums(ecoreg_host_mat[2:ncol(ecoreg_host_mat)])
host_rich_df <- tibble(ecoreg = names(host_rich), host = host_rich)
```

```{r}
actual_para_rich <- get_richness_df(ecoreg_para_mat)
```

```{r}
make_mat <- function(para_df){
para_df %>% 
  dplyr::select(c(para, name, value)) %>% 
  distinct() %>% 
  pivot_wider(., names_from = name, values_from = value) %>%
  replace(is.na(.), 0)
}
```


# plotting function





# actual ecoreg para mat with more attributes

```{r}
ecoreg_para_mat_vars <- ecoreg_para_mat %>% rename(para = ParasiteCorrectedName) %>% 
  left_join(., gmpd_type) %>%
  left_join(., gmpd_traits) %>%
  left_join(., nri) %>%
  left_join(., gmpd_prev) %>%
  left_join(., gmpd_int)

group_vars <- c("ParType", "ParMacroMicro", "mode", "spec_bin", "prev_bin", "int_bin")
```



```{r}
get_ratios <- function(data, VarName){

vars <- data %>% dplyr::select(VarName) %>% distinct() %>% filter(!is.na(.))
  
  
actual_para_first <- ecoreg_para_mat_vars %>% filter(!!sym(VarName) == vars[[1,1]]) %>%
  dplyr::select(-group_vars) %>% get_richness_df(.)
actual_para_second <- ecoreg_para_mat_vars %>% filter(!!sym(VarName) == vars[[2,1]]) %>%
  dplyr::select(-group_vars) %>% get_richness_df(.)

max_rich_first <- null_para_df %>% filter(!!sym(VarName) == vars[[1,1]]) %>% make_mat(.) %>% get_richness_df(.) 
max_rich_second <- null_para_df %>% filter(!!sym(VarName) == vars[[2,1]]) %>% make_mat(.) %>% get_richness_df(.) 



max_rich_first %<>% left_join(., actual_para_first, by=c("ecoreg", "host")) %>% mutate(binary = vars[[1,1]])
max_rich_second %<>% left_join(., actual_para_second, by=c("ecoreg", "host")) %>% mutate(binary = vars[[2,1]])

para_binary_rich <- rbind(max_rich_first, max_rich_second)

para_binary_rich %<>% mutate(ratio = para.y/para.x) %>% filter(!is.na(ratio))

return(para_binary_rich)
}
```


```{r}
type_ratios <- get_ratios(ecoreg_para_mat_vars, "ParMacroMicro")
mode_ratios <- get_ratios(ecoreg_para_mat_vars, "mode")
spec_ratios <- get_ratios(ecoreg_para_mat_vars, "spec_bin")
prev_ratios <- get_ratios(ecoreg_para_mat_vars, "prev_bin")
int_ratios <- get_ratios(ecoreg_para_mat_vars, "int_bin")
```


```{r}
type_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_boxplot() + geom_jitter()
mode_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_boxplot() + geom_jitter()
spec_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_boxplot() + geom_jitter()
prev_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_boxplot() + geom_jitter()
int_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_boxplot() + geom_jitter()
```
```{r}
type_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_violin()
mode_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_violin()
spec_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_violin()
prev_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_violin()
int_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_violin()

```



```{r}
wilcox.test(ratio ~ binary, data = type_ratios)
wilcox.test(ratio ~ binary, data = mode_ratios)
wilcox.test(ratio ~ binary, data = spec_ratios)
wilcox.test(ratio ~ binary, data = prev_ratios)
wilcox.test(ratio ~ binary, data = int_ratios)
```




# macro micro

First, get max richness

```{r}
macro_rich <- null_para_df %>% filter(ParMacroMicro == "macro") %>% make_mat(.) %>% get_richness_df(.) 
micro_rich <- null_para_df %>% filter(ParMacroMicro == "micro") %>% make_mat(.) %>% get_richness_df(.) 
```

Next, get actual richness

```{r}
actual_para_macro <- ecoreg_para_mat_vars %>% filter(ParMacroMicro == "macro") %>%
  dplyr::select(-group_vars) %>% get_richness_df(.)
actual_para_micro <- ecoreg_para_mat_vars %>% filter(ParMacroMicro == "micro") %>%
  dplyr::select(-group_vars) %>% get_richness_df(.)
```

Join and get ratio

```{r}
macro_rich %<>% left_join(., actual_para_macro, by=c("ecoreg", "host")) %>% mutate(type = "macro")
micro_rich %<>% left_join(., actual_para_micro, by=c("ecoreg", "host")) %>% mutate(type = "micro")

para_type_rich <- rbind(macro_rich, micro_rich)

para_type_rich %<>% mutate(ratio = para.y/para.x) %>% filter(!is.na(ratio))

para_type_rich %>% filter(ratio<1 & ratio>0) %>% ggplot(., aes(x=type, y=ratio)) + geom_boxplot()
```



# transmission mode




# specialism




# prevalence




# intensity






```{r}
para_ecoregs <- null_para_df %>% group_by(para) %>% distinct() %>% summarize(tot_ecoreg = n())
```

```{r}
gmpd_para_ecoreg <- ecoreg_para_mat %>% 
  pivot_longer(cols=2:379) %>% 
  filter(value==1) %>%
  group_by(ParasiteCorrectedName) %>%
  distinct() %>%
  summarize(filled_ecoreg = n()) %>%
  rename(para = ParasiteCorrectedName)
  
```






