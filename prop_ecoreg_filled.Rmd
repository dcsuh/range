---
title: "prop_ecoreg_filled"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(magrittr)
library(janitor)
```


# Notes

Why are there positive ratios when we are dividing observed in GMPD over max possible richness per ecoregion?
 - Already tried to restrict data to those in native range but this doesn't fix it
    - may need to ensure that parasite presence is only counted in GMPD if it is within host IUCN range
    - how often does parasite presence in ecoregion per host IUCN data actually match up with gmpd data?
       - I should be able to do this using geoms


# Summary

What is the actual number of ecoregions a parasite is found in compared to the maximum number of ecoregions a parasite could inhabit across different parasite groupings: (1) parasite type, (2) transmission mode, (3) host specificity, (4) high vs. low prevalence, (5) high vs. low intensity?

Overall method: 
Create two evenly sized groups divided by some feature of the parasite
Measure actual number of ecoregions a parasite is found in from GMPD
Measure maximum number of ecoregions a parasite could be found in assuming full host filling
Compare ratio of actual:maximum for all parasites across feature


```{r}
host_para_mat <- readRDS(here("data", "processed_data", "para_mat.rds"))
ecoreg_host_mat <- readRDS(here("data", "processed_data", "ecoreg_mat.rds"))
ecoreg_para_mat <- readRDS(here("data", "processed_data", "ecoreg_para_mat.rds"))
null_para_df <- readRDS(here("data", "processed_data", "null_para_df.rds"))
gmpd_ecoreg_effort <- readRDS(here("data", "processed_data", "gmpd_ecoreg_effort.rds"))

gmpd <- read_csv(here("data", "GMPD", "GMPD_main.csv"))
gmpd_traits <- read_csv(here("data", "GMPD", "GMPD_parasite_traits.csv"))


ecoreg_names <- colnames(ecoreg_para_mat[2:ncol(ecoreg_para_mat)])
```

```{r}
gmpd %<>% filter(NativeRange!="No")
#gmpd %<>% filter(NativeRange!="No" | is.na(NativeRange))
```


# Add column for parasite type
```{r}
gmpd_type <- gmpd %>% dplyr::select(ParasiteCorrectedName, ParType) %>% distinct()

par_type_index <- tibble(ParType = c("Virus", "Bacteria", "Protozoa", "Prion", "Fungus", "Helminth", "Arthropod"),
                         ParMacroMicro = c("micro", "micro", "micro", "micro", "micro", "macro", "macro"))

gmpd_type %<>% left_join(., par_type_index)

gmpd_type %<>% rename(., para = ParasiteCorrectedName)
```

```{r}
para_names <- null_para_df %>% dplyr::select(para) %>% distinct()
gmpd_type %<>% filter(para %in% para_names$para)
```

There are some parasites called "not identified to genus" and these are different parasites so are creating issues when joining dataframes
```{r}
gmpd_type %<>% filter(!para == "not identified to genus")
null_para_df %<>% filter(!para == "not identified to genus")

```


```{r}
null_para_df %<>% left_join(., gmpd_type)
```

# Add column for transmission mode
```{r}
gmpd_mode <- gmpd_traits %>% mutate(mode = 
                           ifelse(close == TRUE | nonclose == TRUE,
                                  "direct",
                                  "indirect")) %>%
  filter(!is.na(mode)) #remove parasites without mode data

gmpd_mode %<>% rename(para=ParasiteCorrectedName) %>% dplyr::select(para, mode)
```


```{r}
null_para_df %<>% left_join(., gmpd_mode)
```



# Add column for host specificity
```{r}
load(file=here("data", "GMPD", "get_nri.Rda"))
nri %<>% rownames_to_column(., var = "para")

nri %<>% 
  filter(!is.na(mpd.obs.z)) %>%
  mutate(spec_bin = ifelse(
    mpd.obs.z<median(mpd.obs.z), #class determined above or below median
    "specialist",
    "generalist"
  ))

tabyl(nri$spec_bin)

nri %<>% dplyr::select(para, spec_bin)

null_para_df %<>% left_join(., nri)
```


# Add column for prevalence
```{r}
gmpd_prev <- gmpd %>% 
  dplyr::select(ParasiteCorrectedName, Prevalence) %>%
  filter(!is.na(Prevalence)) %>%
  group_by(ParasiteCorrectedName) %>%
  summarize(Prevalence=mean(Prevalence)) %>% #get average prevalence
  mutate(prev_bin = ifelse(
    Prevalence > median(Prevalence), #above or below median
    "high_prevalence",
    "low_prevalence"
  ))

tabyl(gmpd_prev$prev_bin)

gmpd_prev %<>% rename(para = ParasiteCorrectedName) %>% dplyr::select(para, prev_bin)

null_para_df %<>% left_join(., gmpd_prev)
```



# Add column for intensity
```{r}
gmpd_int <- gmpd %>%
  dplyr::select(ParasiteCorrectedName, Intensity) %>%
  mutate(Intensity = as.numeric(Intensity)) %>% #some intensity measures included characters to indicate exponent or range. these are removed for now
  filter(!is.na(Intensity)) %>%
  filter(Intensity>0) %>% #some intensity measures were 0. these were removed
  group_by(ParasiteCorrectedName) %>%
  summarize(Intensity = mean(Intensity)) %>% #get average intensity
  mutate(int_bin = ifelse(
    Intensity > median(Intensity), #above or below median
    "high_intensity",
    "low_intensity"
  ))

tabyl(gmpd_int$int_bin)

gmpd_int %<>% rename(para = ParasiteCorrectedName) %>% dplyr::select(para, int_bin)

null_para_df %<>% left_join(., gmpd_int)
```






# actual ecoreg para mat with more attributes

```{r}
ecoreg_para_mat_vars <- ecoreg_para_mat %>% rename(para = ParasiteCorrectedName) %>% 
  left_join(., gmpd_type) %>%
  left_join(., gmpd_mode) %>%
  left_join(., nri) %>%
  left_join(., gmpd_prev) %>%
  left_join(., gmpd_int)

group_vars <- c("ParType", "ParMacroMicro", "mode", "spec_bin", "prev_bin", "int_bin")
```

# proportion filled function


```{r}
get_para_ecoreg <- function(VarName){
  
  vars <- null_para_df %>% dplyr::select(VarName) %>% distinct() %>% filter(!is.na(.))

  actual_ecoreg_first <- ecoreg_para_mat_vars %>% 
    filter(!!sym(VarName) == vars[[1,1]]) %>% 
    dplyr::select(-group_vars) %>%
    pivot_longer(all_of(ecoreg_names)) %>%
    filter(value == TRUE) %>%
    group_by(para) %>%
    distinct() %>%
    summarize(n_ecoreg = n())
    
  actual_ecoreg_second <- ecoreg_para_mat_vars %>% 
    filter(!!sym(VarName) == vars[[2,1]]) %>% 
    dplyr::select(-group_vars) %>%
    pivot_longer(all_of(ecoreg_names)) %>%
    filter(value == TRUE) %>%
    group_by(para) %>%
    distinct() %>%
    summarize(n_ecoreg = n())
  
  max_ecoreg_first <- null_para_df %>% 
    filter(!!sym(VarName) == vars[[1,1]]) %>% 
    dplyr::select(para, name) %>% 
    group_by(para) %>% distinct() %>% 
    summarize(n_ecoreg = n())
  
  max_ecoreg_second <- null_para_df %>% 
    filter(!!sym(VarName) == vars[[2,1]]) %>% 
    dplyr::select(para, name) %>% 
    group_by(para) %>% distinct() %>% 
    summarize(n_ecoreg = n())
  
  max_ecoreg_first %<>% 
    left_join(., actual_ecoreg_first, by=c("para")) %>% 
    mutate(
      n_ecoreg.y = replace_na(n_ecoreg.y, 0),
      binary = vars[[1,1]])
  
  max_ecoreg_second %<>% 
    left_join(., actual_ecoreg_second, by=c("para")) %>% 
    mutate(
      n_ecoreg.y = replace_na(n_ecoreg.y, 0),
      binary = vars[[2,1]])
  
  para_binary_ecoreg <- rbind(max_ecoreg_first, max_ecoreg_second)
  
  para_binary_ecoreg %<>% mutate(ratio = n_ecoreg.y/n_ecoreg.x)
    
  return(para_binary_ecoreg)
}
```








```{r}
type_ratios <- get_para_ecoreg("ParMacroMicro")
mode_ratios <- get_para_ecoreg("mode")
spec_ratios <- get_para_ecoreg("spec_bin")
prev_ratios <- get_para_ecoreg("prev_bin")
int_ratios <- get_para_ecoreg("int_bin")
```


```{r}
type_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_boxplot() + geom_jitter()
mode_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_boxplot() + geom_jitter()
spec_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_boxplot() + geom_jitter()
prev_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_boxplot() + geom_jitter()
int_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_boxplot() + geom_jitter()
```

```{r}
type_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_violin()
mode_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_violin()
spec_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_violin()
prev_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_violin()
int_ratios %>% filter(ratio<1) %>% ggplot(., aes(x=binary, y=ratio)) + geom_violin()

```


two-tailed, non-parametric
```{r}
wilcox.test(ratio ~ binary, data = type_ratios)
wilcox.test(ratio ~ binary, data = mode_ratios)
wilcox.test(ratio ~ binary, data = spec_ratios)
wilcox.test(ratio ~ binary, data = prev_ratios)
wilcox.test(ratio ~ binary, data = int_ratios)
```


Do this once more but for all of the parasites and all of the ecoregions without subsetting to the different binary groups.

Then see if there are any patterns when we break those groups up by traits.

Max ecoreg filled per parasite
```{r}
max_ecoreg <- null_para_df %>% 
  group_by(para) %>% 
  dplyr::select(para, name) %>% 
  distinct() %>% 
  summarize(max_ecoreg = n())
```

```{r}
actual_ecoreg <- ecoreg_para_mat_vars %>% 
    dplyr::select(-group_vars) %>%
    pivot_longer(all_of(ecoreg_names)) %>%
    filter(value == TRUE) %>%
    group_by(para) %>%
    distinct() %>%
    summarize(n_ecoreg = n())
```

```{r}
ecoreg_binary <- null_para_df %>%
  group_by(para) %>%
  dplyr::select(para, ParMacroMicro:int_bin) %>%
  distinct()
```


```{r}
ecoreg_filled <- left_join(max_ecoreg, actual_ecoreg, by = "para")
ecoreg_filled %<>% left_join(., ecoreg_binary, by = "para")
ecoreg_filled %<>% mutate(ratio = n_ecoreg/max_ecoreg)
```

```{r}
ecoreg_filled %<>% filter(!is.na(ratio))
```


```{r}
ecoreg_filled %>% filter(!is.na(ParMacroMicro)) %>%
  ggplot(., aes(x=ParMacroMicro, y=ratio)) + geom_violin()

ecoreg_filled %>% filter(!is.na(mode)) %>%
  ggplot(., aes(x=mode, y=ratio)) + geom_violin()

ecoreg_filled %>% filter(!is.na(spec_bin)) %>%
  ggplot(., aes(x=spec_bin, y=ratio)) + geom_violin()

ecoreg_filled %>% filter(!is.na(prev_bin)) %>%
  ggplot(., aes(x=prev_bin, y=ratio)) + geom_violin()

ecoreg_filled %>% filter(!is.na(int_bin)) %>%
  ggplot(., aes(x=int_bin, y=ratio)) + geom_violin()
```

```{r}
wilcox.test(ratio ~ ParMacroMicro, data = ecoreg_filled)
wilcox.test(ratio ~ mode, data = ecoreg_filled)
wilcox.test(ratio ~ spec_bin, data = ecoreg_filled)
wilcox.test(ratio ~ prev_bin, data = ecoreg_filled)
wilcox.test(ratio ~ int_bin, data = ecoreg_filled)
```












