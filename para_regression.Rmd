---
title: "para_regression"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(magrittr)
```


```{r}
host_para_mat <- readRDS(here("data", "processed_data", "para_mat.rds"))
ecoreg_host_mat <- readRDS(here("data", "processed_data", "ecoreg_mat.rds"))
ecoreg_para_mat <- readRDS(here("data", "processed_data", "ecoreg_para_mat.rds"))
null_para_df <- readRDS(here("data", "processed_data", "null_para_df.rds"))
gmpd_ecoreg_effort <- readRDS(here("data", "processed_data", "gmpd_ecoreg_effort.rds"))
```

Null regression
Set probability of occupancy of a parasite in a host's ecoregion to some arbitrary number (0.05-1) and observe how this influences relationship between host richness and parasite richness at the ecoregion level. Then we compare this to the actual data.


```{r}
null_prop <- seq(0.1, 0.01, by = -0.01)
```



```{r}
para_df_list <- list()
for(i in 1:length(null_prop)){
 para_df_list[[i]] <- null_para_df %>% 
   group_by(sci_name, para) %>% 
   slice_sample(prop = null_prop[i]) %>% 
   ungroup()
}

names(para_df_list) <- null_prop

```



```{r, make mat}
make_mat <- function(para_df){
para_df %>% 
  dplyr::select(c(para, name, value)) %>% 
  distinct() %>% 
  pivot_wider(., names_from = name, values_from = value) %>%
  replace(is.na(.), 0)
}

para_mat_list <- lapply(para_df_list, make_mat)
```


Null regression

100% coverage
```{r}
host_rich <- colSums(ecoreg_host_mat[2:ncol(ecoreg_host_mat)])
host_rich_df <- tibble(ecoreg = names(host_rich), host = host_rich)
```

```{r}
get_richness_df <- function(para_mat){
  para_rich <- colSums(para_mat[2:ncol(para_mat)])
  
  tmp <- tibble(para = para_rich, ecoreg = names(para_rich))
  
  tmp %>% left_join(., host_rich_df) %>% replace(is.na(.), 0)
}
```


```{r}
null_richness_list <- lapply(para_mat_list, get_richness_df)
```



```{r}
get_lm <- function(df){
  lm(para ~ host, df)
}

lm_list <- lapply(null_richness_list, get_lm)
```

```{r}
null_plots <- list()
for(i in 1:length(null_richness_list)){
  null_plots[[i]] <- null_richness_list[[i]] %>% ggplot(., aes(x=host, y=para)) + geom_point() + geom_smooth(method = "lm") + labs(title = names(null_richness_list[i])) + xlim(0,65) + ylim(0,270)
}
```

```{r}
null_plots
```

```{r}
lapply(lm_list, coef)
```




Actual regression

```{r}
actual_para_rich <- get_richness_df(ecoreg_para_mat)

saveRDS(actual_para_rich, file = here("data", "processed_data", "gmpd_ecoreg_psr.rds"))
```


```{r}
actual_para_rich %>% filter(para>0) %>% ggplot(.,aes(x=host, y=para)) + geom_point() + geom_smooth(method="lm")

summary(lm(para ~ host, data = actual_para_rich))
```

# Weight by ecoregion study effort

Let's do this again but now assume that a parasite is more likely to be in an ecoregion if that ecoregion is also more well-studied

First, we'll look at the distribution of ecoregion study effort (number of gmpd studies published per ecoregion)
```{r}
gmpd_ecoreg_effort %<>% rename(., name = ECO_CODE)


gmpd_ecoreg_effort %>% group_by(n) %>% summarize(volume = n()) %>% ggplot(., aes(x=volume)) + geom_histogram(binwidth = 1)
```

So I can try to use this raw value in some way to assign a probability that a parasite is present in an ecoregion

We can also use other methods such as rarefaction or Chao2 to determine actual presence.

I'll start by trying to use the raw values in some way


```{r}
para_ecoreg_effort <- null_para_df %>% left_join(., gmpd_ecoreg_effort) 

para_ecoreg_effort %<>% mutate(n = replace_na(n, 0))

ecoreg_count <- para_ecoreg_effort %>% group_by(sci_name, para) %>% summarize(ecoreg_count = n()) %>% ungroup()

para_ecoreg_effort %<>% left_join(., ecoreg_count)

para_ecoreg_effort %<>% mutate(n_times = ifelse(n==0, 1, n)) #turn 0's into 1's for replicate count

effort_weighted <- para_ecoreg_effort %>% uncount(., n_times) #generate row per citation from ecoreg_count
#uncount replicates row per number of times specified
```

effort_weighted is a df where each parasite-host-ecoregion entry is duplicated according to the number of gmpd entries per ecoregion. We duplicate rows so that ecoregions with higher study effort are more likely to yield a presence in the null model because each row is subject to a bernoulli trial so more rows means more opportunities for successul trial (i.e., presence)
```{r}
weighted_prop <- seq(0.01, 0.001, by=-0.0005)
weighted_prop_list <- list()

for(i in 1:length(weighted_prop)){
  weighted_prop_list[[i]] <- effort_weighted %>% 
  mutate(included = rbinom(value, 1, prob=weighted_prop[i])) %>% 
  filter(included==T) %>%
  distinct()
}

names(weighted_prop_list) <- weighted_prop
```

```{r}
weighted_mat_list <- lapply(weighted_prop_list, make_mat)
weighted_richness <- lapply(weighted_mat_list, get_richness_df)


weighted_plots <- list()
for(i in 1:length(weighted_richness)){
  weighted_plots[[i]] <- weighted_richness[[i]] %>% ggplot(., aes(x=host, y=para)) + geom_point() + geom_smooth(method = "lm") + labs(title = names(weighted_richness[i])) + xlim(0,65) + ylim(0,270)
}
```

```{r}
weighted_plots
```

```{r}
weighted_lm <- lapply(weighted_richness, get_lm)
```


```{r}
lapply(weighted_lm, coef)
```

```{r}
actual_para_rich %>% filter(para>0) %>% ggplot(.,aes(x=host, y=para)) + geom_point() + geom_smooth(method="lm")

summary(lm(para ~ host, data = actual_para_rich))
```

```{r}
gmpd_ecoreg_effort %<>% rename(ecoreg = name)

tmp <- left_join(actual_para_rich, gmpd_ecoreg_effort)

ggplot(tmp, aes(x=n, y=para)) + geom_point() + geom_smooth(method="lm")


summary(glm(para ~ n + host, family=poisson, data=tmp))
```



# Actual Regression Residuals

What explains the residuals in host-parasite richness?

Is it due to ecoregion study effort?

```{r}
actual_lm <- lm(para ~ host, data = actual_para_rich)
ecoreg_resids <- actual_para_rich %>% mutate(resid=resid(actual_lm))

ecoreg_resids %<>% left_join(., gmpd_ecoreg_effort)
```

Pretty good fit
```{r}
ecoreg_resids %>% ggplot(., aes(x=n, y=resid)) + 
  geom_point() + 
  geom_smooth(method="lm") + 
  labs(title = "Residuals~Study Effort",
       x = "number of studies per ecoregion",
       y = "residual from PR~HR by ecoregion")

summary(lm(resid ~ n, data=ecoreg_resids))
```









